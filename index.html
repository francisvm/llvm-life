<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>LLVM / Clang</title>
    <style>
      @import url(https://fonts.googleapis.com/css?family=Source+Code+Pro);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono);
      @import url(https://fonts.googleapis.com/css?family=Inconsolata);

      body {
        font-family: 'Source Code Pro';
      }
      h1, h2, h3 {
        font-family: 'Inconsolata';
        font-weight: 400;
        margin-bottom: 0;
      }
      .remark-slide-scaler {
        background-color: transparent;
        overflow: hidden;
        position: absolute;
        -webkit-transform-origin: top left;
        -moz-transform-origin: top left;
        transform-origin: top-left;
        -moz-box-shadow: 0 0 0px #111;
        -webkit-box-shadow: 0 0 0px #111;
        box-shadow: 0 0 0px #111;
      }
      .remark-slides-area { background: #111111; }
      .remark-slide-container {
        background: transparent url("sources/lse.png") no-repeat left bottom;
      }
      .remark-slide-content h1 { font-size: 2.8em; }
      .remark-slide-content h2 { font-size: 2em; }
      .remark-slide-content h3 { font-size: 1.6em; }
      .remark-slide-content h3 { font-size: 1.6em; }
      .remark-code { text-align: left; }
      .remark-code-line-highlighted {
        background: rgba(168, 0, 0, 0.1);
        -moz-box-shadow: 0 0 8px #111;
        -webkit-box-shadow: 0 0 8px #111;
        box-shadow: 0 0 8px #111;
      }
      .footnote {
        position: absolute;
        bottom: 3em;
        font-size: 9pt;
      }
      a, a > code {
        color: #cc6666;
        text-decoration: none;
      }
      code {
        border-radius: 8px;
        font-family: 'Ubuntu Mono';
      }
      .inverse {
        background: #111111;
        color: #cfcfcf;
        text-shadow: 0 0 5px #000;
        position: left;
      }
      .inverse h1, .inverse h2 {
        color: #c5c8c6;
        line-height: 0.8em;
      }

      /* Slide-specific styling */
      #slide-inverse .footnote {
        bottom: 12px;
        left: 20px;
      }
      #slide-how .slides {
        font-size: 0.9em;
        position: absolute;
        top:  151px;
        right: 140px;
      }
      #slide-how .slides h3 {
        margin-top: 0.2em;
      }
      #slide-how .slides .first, #slide-how .slides .second {
        padding: 1px 20px;
        height: 90px;
        width: 120px;
        -moz-box-shadow: 0 0 10px #777;
        -webkit-box-shadow: 0 0 10px #777;
        box-shadow: 0 0 10px #777;
      }
      #slide-how .slides .first {
        background: #fff;
        position: absolute;
        top: 20%;
        left: 20%;
        z-index: 1;
      }
      #slide-how .slides .second {
        position: relative;
        background: #fff;
        z-index: 0;
      }
      li {
        text-align: left;
      }
      .clangcfg img {
        max-width: 75%;
      }
      .selectiondag img {
        max-width: 63%;
      }
      .selectiondagmodified img {
        max-width: 50%;
      }

      .mcinst {
        margin: 0 auto;
        max-width: 53%;
      }
      .objdump {
        margin: 0 auto;
        max-width: 84%;
      }
      .asmprinter {
        margin: 0 auto;
        max-width: 80%;
      }
      .twitter {
        font-size: 9pt;
      }
      .llvm img {
        max-width:25%;
      }
      .urls {
        padding-bottom: 30px;
      }
      .urls * {
        font-size: 8pt;
        text-align: left;
      }

    </style>
  </head>
  <body>
    <textarea id="source">
name: inverse
layout: true
class: center, middle, inverse
---
# rife of an instruction in
# Clang / LLVM

.llvm[![LLVM](sources/llvm.png)]

##### Francis Visoiu Mistrih - <francis@lse.epita.fr>

---

## Clang

##### foo.c - C

```c++
int foo(int a, int b)
{
*  return a + b;
}
```

---

## Clang AST

##### clang-check -ast-dump foo.c

```clangast
TranslationUnitDecl 0x29eaa20
`-FunctionDecl 0x29eb460 <foo.c:1:1, line:4:1> line:1:5 foo 'int (int, int)'
  |-ParmVarDecl 0x29eb318 <col:9, col:13> col:13 used a 'int'
  |-ParmVarDecl 0x29eb388 <col:16, col:20> col:20 used b 'int'
  `-CompoundStmt 0x29eb618 <line:2:1, line:4:1>
    `-ReturnStmt 0x29eb600 <line:3:3, col:14>
*      `-BinaryOperator 0x29eb5d8 <col:10, col:14> 'int' '+'
        |-ImplicitCastExpr 0x29eb5a8 <col:10> 'int' <LValueToRValue>
        | `-DeclRefExpr 0x.. <col:10> 'int' lvalue ParmVar 0x29eb318 'a' 'int'
        `-ImplicitCastExpr 0x29eb5c0 <col:14> 'int' <LValueToRValue>
          `-DeclRefExpr 0x.. <col:14> 'int' lvalue ParmVar 0x29eb388 'b' 'int'
```

---

## Clang CFG

##### clang -cc1 -analyze -analyzer-checker=debug.ViewCFG foo.c

.clangcfg[![CFG](sources/clang-cfg.modified.jpg)]

---

## LLVM IR

##### clang -O1 -S -emit-llvm foo.c -o foo.ll

```llvm
; Function Attrs: norecurse nounwind readnone uwtable
define i32 @foo(i32 %a, i32 %b) {
entry:
* %add = add nsw i32 %b, %a
  ret i32 %add
}
```
---

.selectiondag[![SelectionDAG](sources/selection-dag.jpg)]

---

## TargetLowering - SelectionDAG

#### SDNode

##### llc -O1 -view-dag-combine1-dags foo.ll

.selectiondagmodified[![SelectionDAG](sources/selection-dag.modified.jpg)]

---

## SelectionDAG legalization

#### SDNode

##### llc -O1 -view-isel-dags foo.ll

* Remove illegal types
```llvm
i1 -> i32
```

* Remove target-illegal instructions
```llvm
mul i32 %a, 8
```
to
```llvm
shl i32 %a, 3
```

---

## SelectionDAGISel

#### MachineSDNode

##### llc -O1 -view-sched-dags foo.ll

.selectiondagmodified[![SelectionDAG](sources/selection-dag-isel.modified.jpg)]

---

## SelectionDAGISel

#### MachineSDNode

##### llvm/lib/Target/X86/X86InstrCompiler.td

```tablegen
def : Pat<(add GR32:$src1, GR32:$src2), (ADD32rr GR32:$src1, GR32:$src2)>;
```

---

## ScheduleDAG

#### MachineInstr

##### llc -O1 -print-before=expand-isel-pseudos foo.ll

```llvm
Function Live Ins: %EDI in %vreg0, %ESI in %vreg1

BB#0: derived from LLVM BB %entry
  Live Ins: %EDI %ESI
    %vreg1<def> = COPY %ESI; GR32:%vreg1
    %vreg0<def> = COPY %EDI; GR32:%vreg0
*   %vreg2<def,tied1> = ADD32rr %vreg0<tied0>, %vreg1, %EFLAGS<imp-def,dead>
    %EAX<def> = COPY %vreg2; GR32:%vreg2
    RET 0, %EAX
```

---

## Register allocation

#### Non-SSA MachineInstr

##### llc -O1 -print-machineinstrs=virtregrewriter foo.ll

```llvm
Function Live Ins: %EDI, %ESI

0B  BB#0: derived from LLVM BB %entry
      Live Ins: %EDI %ESI
*80B     %EAX<def> = LEA64_32r %RDI<kill>, 1, %RSI<kill>, 0, %noreg
112B    RET 0, %EAX
```

---

## MCInstLower

#### MCInst

##### llc -O1 -asm-show-inst foo.ll -o foo.s

.mcinst[
```mcinst
 @foo
 %entry
*<MCInst #1278 LEA64_32r
  <MCOperand Reg:19>
  <MCOperand Reg:39>
  <MCOperand Imm:1>
  <MCOperand Reg:43>
  <MCOperand Imm:0>
  <MCOperand Reg:0>>
<MCInst #2472 RETQ
  <MCOperand Reg:19>>
```
]

---

## AsmPrinter

#### Assembly

##### llc -O1 foo.ll -o foo.s / clang -O1 foo.c -S -o foo.s

.asmprinter[
```x86
foo:                                    # @foo
# BB#0:                                 # %entry
*       leal    (%rdi,%rsi), %eax       # <MCInst #1278 LEA64_32r
                                        #  <MCOperand Reg:19>
                                        #  <MCOperand Reg:39>
                                        #  <MCOperand Imm:1>
                                        #  <MCOperand Reg:43>
                                        #  <MCOperand Imm:0>
                                        #  <MCOperand Reg:0>>
        retq                            # <MCInst #2472 RETQ
```
]

---

## AsmPrinter

#### Assembly

##### lib/Target/X86/X86InstrArithmetic.td

```tablegen
*def LEA64_32r : I<0x8D, MRMSrcMem,
                  (outs GR32:$dst), (ins lea64_32mem:$src),
                  "lea{l}\t{$src|$dst}, {$dst|$src}",
                  [(set GR32:$dst, lea64_32addr:$src)], IIC_LEA>,
                  OpSize32, Requires<[In64BitMode]>;
```

---

## AsmPrinter

#### Assembly

##### lib/Target/X86/X86InstrArithmetic.td

```tablegen
def LEA64_32r : I<0x8D, MRMSrcMem,
*                 (outs GR32:$dst), (ins lea64_32mem:$src),
                  "lea{l}\t{$src|$dst}, {$dst|$src}",
                  [(set GR32:$dst, lea64_32addr:$src)], IIC_LEA>,
                  OpSize32, Requires<[In64BitMode]>;
```

---

## AsmPrinter

#### Assembly

##### lib/Target/X86/X86InstrArithmetic.td

```tablegen
def LEA64_32r : I<0x8D, MRMSrcMem,
                  (outs GR32:$dst), (ins lea64_32mem:$src),
*                 "lea{l}\t{$src|$dst}, {$dst|$src}",
                  [(set GR32:$dst, lea64_32addr:$src)], IIC_LEA>,
                  OpSize32, Requires<[In64BitMode]>;
```

---

## AsmPrinter

#### Assembly

##### lib/Target/X86/X86InstrArithmetic.td

```tablegen
def LEA64_32r : I<0x8D, MRMSrcMem,
                  (outs GR32:$dst), (ins lea64_32mem:$src),
                  "lea{l}\t{$src|$dst}, {$dst|$src}",
*                 [(set GR32:$dst, lea64_32addr:$src)], IIC_LEA>,
                  OpSize32, Requires<[In64BitMode]>;
```

---

## MCCodeEmitter

#### ELF

##### clang -c -fintegrated-as -O1 foo.c -o foo.o
##### llvm-objdump -disassemble foo.o

.objdump[
```objdump
foo:
*      0:       8d 04 37        leal    (%rdi,%rsi), %eax
       3:       c3              retq
```
]

---

#### References

.urls[
* http://eli.thegreenplace.net/2012/11/24/life-of-an-instruction-in-llvm
* http://llvm.org/git/llvm.git
* http://llvm.org/docs/CodeGenerator.html
]

## Any questions?

###### <francis@lse.epita.fr>

.twitter[[@thegameg](https://twitter.com/thegameg)]

.footnote[Slideshow created using [remark](http://github.com/gnab/remark).]
    </textarea>
    <script src="vendor/remark.js"></script>
    <script>
      var hljs = remark.highlighter.engine;
    </script>
    <script>
      var slideshow = remark.create({
          highlightStyle: 'tomorrow-night',
          highlightLanguage: 'c++',
          highlightLines: true
        }) ;
    </script>
  </body>
</html>
